## 状态的定义及转移方程

记 $f(x, i), i > 0$ 表示：对于以 $x$ 为根的子树，$x$ 被选中，且包含 $x$ 的连通块的深度不超过 $i$ 时的最优解。

再记 $f(x, 0)$ 表示：当 $x$ 不被选中时，子树 $x$ 的最优解。

其中，深度表示结点个数。特别地，$f(x, 0)$ 表示当 $x$ 未被选中时的最优解。

我们有转移方程：
$$
f(x, i) = \sum_{y \in son(x)} f(y, i - 1) + w(x), i > 0
$$
$$
f(x, 0) = \sum_{y \in son(x)} f(y, \infty)
$$

记 $len(x)$ 表示 子树 $x$ 的深度。当 $i \geq len(x)$ 时，$f(x, i) = f(x, \infty)$

---

## 长剖的实现方案

对于结点 $x$，我们在长链上记录 $f(x, i), i\in [0, len(x))$

额外再为每一个结点记录 $g(x) = f(x, \infty)$

转移策略：

- 1.先预处理每一个儿子的答案。
- 2.区间加：$f(x, i) \leftarrow w(x), i \in [1, len(x))$
- 3.对于所有轻儿子，遍历轻链，单点加：$f(x, i + 1) \leftarrow f(y, i), i \in [0, len(y))$
- 4.遍历轻儿子时区间加：$f(x, i)\leftarrow g(y), i> len(y)$
- 5.直接转移：$f(x, 0) = \sum_{y \in son(x)} g(y)$
- 6.直接转移：$g(x) = f(x, len(x)) = \sum_{y\in son(x)} f(y, len(x) - 1)$

可以用线段树实现区间加。

然而因为长链剖分的修改永远发生在查询之前，所以可以在长链上再维护一个差分数组来将修改推迟到查询时，即在区间加时为差分数组打上标记，在查询短链 $y$ 时求前缀和统计答案。